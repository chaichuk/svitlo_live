blueprint:
  name: "Svitlo Live: –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è + Telegram"
  description: "–ù–∞–¥—Å–∏–ª–∞—î push —Ç–∞ Telegram –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—ñ–≤ –ê–ë–û –≤–≤–µ–¥–µ–Ω–Ω—è –µ–∫—Å—Ç—Ä–µ–Ω–∏—Ö –≤—ñ–¥–∫–ª—é—á–µ–Ω—å. –ú–∞—î –≤–±—É–¥–æ–≤–∞–Ω—É –∑–∞—Ç—Ä–∏–º–∫—É 50 —Ö–≤ –Ω–∞ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è –∞–≤–∞—Ä—ñ—ó."
  domain: automation
  source_url: https://github.com/chaichuk/svitlo_live

  input:
    schedule_calendar:
      name: –ö–∞–ª–µ–Ω–¥–∞—Ä Svitlo Live
      selector:
        entity:
          domain: calendar
          integration: svitlo_live

    schedule_updated_sensor:
      name: –°–µ–Ω—Å–æ—Ä –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—É
      description: "–û–±–µ—Ä—ñ—Ç—å sensor 'Schedule updated' –¥–ª—è —Ü—å–æ–≥–æ —Ä–µ–≥—ñ–æ–Ω—É"
      selector:
        entity:
          domain: sensor
          integration: svitlo_live

    emergency_sensor:
      name: –°–µ–Ω—Å–æ—Ä –∞–≤–∞—Ä—ñ–π–Ω–∏—Ö –≤—ñ–¥–∫–ª—é—á–µ–Ω—å
      description: "–û–±–µ—Ä—ñ—Ç—å binary_sensor 'Emergency outages' (—è–∫—â–æ —î)"
      default: {}
      selector:
        entity:
          domain: binary_sensor
          integration: svitlo_live

    mobile_targets:
      name: –ú–æ–±—ñ–ª—å–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó (HA App)
      default: []
      selector:
        device:
          integration: mobile_app
          multiple: true

    telegram_chat_id:
      name: Telegram Chat ID
      description: "ID —á–∞—Ç—É/–≥—Ä—É–ø–∏. –ú–æ–∂–Ω–∞ –¥–µ–∫—ñ–ª—å–∫–∞ —á–µ—Ä–µ–∑ –∫–æ–º—É. –ü—É—Å—Ç–æ = –±–µ–∑ Telegram."
      default: ""
      selector:
        text:

    title_text:
      name: –ó–∞–≥–æ–ª–æ–≤–æ–∫ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π)
      default: "‚ö†Ô∏è –û–Ω–æ–≤–ª–µ–Ω–æ –≥—Ä–∞—Ñ—ñ–∫–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å!"
      selector:
        text:

    location_name:
      name: –õ–æ–∫–∞—Ü—ñ—è
      default: "–î—ñ–º"
      selector:
        text:

    storage_helper:
      name: Helper –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
      description: "Text helper –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É (—â–æ–± –Ω–µ –±—É–ª–æ –¥—É–±–ª—ñ–≤)"
      selector:
        entity:
          domain: input_text

    text_output:
      name: Helper –¥–ª—è —Ç–µ–∫—Å—Ç—É —Ä–æ–∑–∫–ª–∞–¥—É (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)
      description: "–°—é–¥–∏ –±—É–¥–µ –∑–∞–ø–∏—Å—É–≤–∞—Ç–∏—Å—å –≥–æ—Ç–æ–≤–∏–π —Ç–µ–∫—Å—Ç"
      default: {}
      selector:
        entity:
          domain: input_text

    send_persistent_notification:
      name: –°—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ persistent_notification –≤ HA
      default: true
      selector:
        boolean:

    send_on_first_run:
      name: –ù–∞–¥—Å–∏–ª–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É
      default: true
      selector:
        boolean:

mode: restart

variables:
  cal_entity: !input schedule_calendar
  emergency_entity: !input emergency_sensor
  mobile_targets: !input mobile_targets
  telegram_chat_id: !input telegram_chat_id
  base_title: !input title_text
  location_name: !input location_name
  storage_helper: !input storage_helper
  text_output: !input text_output
  send_persistent_notification: !input send_persistent_notification
  send_on_first_run: !input send_on_first_run

  # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å –∞–≤–∞—Ä—ñ—ó
  is_emergency: >-
    {% if emergency_entity %}
      {{ is_state(emergency_entity, 'on') }}
    {% else %}
      false
    {% endif %}

  # –í–∏–∑–Ω–∞—á–∞—î–º–æ, —á–∏ —Å–ø—Ä–∞—Ü—é–≤–∞–≤ —Ç—Ä–∏–≥–µ—Ä —á–µ—Ä–µ–∑ –∑–º—ñ–Ω—É –∞–≤–∞—Ä—ñ–π–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å—É
  triggered_by_emergency: >-
    {{ trigger.entity_id is defined and trigger.entity_id == emergency_entity }}

trigger:
  - platform: state
    entity_id: !input schedule_updated_sensor
  - platform: state
    entity_id: !input emergency_sensor

condition:
  - condition: template
    value_template: "{{ trigger.from_state.state not in ['unknown', 'unavailable'] }}"
  # –ü—Ä–∏ –∞–≤–∞—Ä—ñ—ó —ñ–≥–Ω–æ—Ä—É—î–º–æ —á–∞—Å–æ–≤—ñ —Ä–∞–º–∫–∏ (–≤–∞–∂–ª–∏–≤–æ –∑–Ω–∞—Ç–∏ –ø—Ä–æ —Ü–µ —ñ –≤–Ω–æ—á—ñ)
  - condition: or
    conditions:
      - condition: template
        value_template: "{{ triggered_by_emergency }}"
      - condition: time
        after: "05:00:00"
        before: "23:40:00"

action:
  - if:
      - condition: template
        value_template: "{{ triggered_by_emergency and not is_emergency }}"
    then:
      - delay: 
          minutes: 50

  # 1) –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ–¥—ñ—ó –∫–∞–ª–µ–Ω–¥–∞—Ä—è
  - service: calendar.get_events
    target:
      entity_id: !input schedule_calendar
    data:
      start_date_time: "{{ today_at('00:00').isoformat() }}"
      end_date_time: "{{ (today_at('00:00') + timedelta(days=2) - timedelta(seconds=1)).isoformat() }}"
    response_variable: cal_resp

  - variables:
      raw_events: >-
        {% set r = cal_resp %}{% set k = cal_entity %}
        {% if r is mapping and (k in r) and (r[k] is mapping) and ('events' in r[k]) %}
          {{ r[k]['events'] | sort(attribute='start') }}
        {% else %}[]{% endif %}

      # –§–æ—Ä–º—É—î–º–æ –ø—ñ–¥–ø–∏—Å –≥—Ä–∞—Ñ—ñ–∫–∞
      schedule_signature: >-
        {%- set ns = namespace(sig='') -%}
        {%- for e in raw_events -%}
          {%- set s = as_datetime(e.start).strftime('%y%m%d%H%M') -%}
          {%- set t = as_datetime(e.end).strftime('%y%m%d%H%M') -%}
          {%- set ns.sig = ns.sig ~ s ~ t -%}
        {%- endfor -%}
        {{ ("c=" ~ (raw_events|count|string) ~ ";" ~ ns.sig) | trim }}

      old_signature: "{{ states(storage_helper) | default('') }}"

      # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–º—ñ–Ω
      has_changed: >-
        {% if triggered_by_emergency %}
          true
        {% elif is_emergency %}
          false
        {% elif send_on_first_run %}
          {{ schedule_signature[-255:] != old_signature }}
        {% else %}
          {{ schedule_signature[-255:] != old_signature and old_signature != '' }}
        {% endif %}

  - if:
      - condition: template
        value_template: "{{ has_changed }}"
    then:
      - variables:
          # --- –§–æ—Ä–º—É–≤–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É ---
          events_today: >-
            {% set today = now().astimezone(now().tzinfo).date() %}
            {% set current_time = now().astimezone(now().tzinfo) %}
            {% set ns = namespace(events=[]) %}
            {% for e in raw_events %}
              {% set e_start = as_datetime(e.start).astimezone(now().tzinfo) %}
              {% set e_end = as_datetime(e.end).astimezone(now().tzinfo) %}
              {% if e_start.date() == today and e_end > current_time %}
                {% set ns.events = ns.events + [e] %}
              {% endif %}
            {% endfor %}
            {{ ns.events }}

          events_tomorrow: >-
            {% set tomorrow = (now().astimezone(now().tzinfo) + timedelta(days=1)).date() %}
            {% set ns = namespace(events=[]) %}
            {% for e in raw_events %}
              {% if as_datetime(e.start).astimezone(now().tzinfo).date() == tomorrow %}
                {% set ns.events = ns.events + [e] %}
              {% endif %}
            {% endfor %}
            {{ ns.events }}

          # --- –î–ò–ù–ê–ú–Ü–ß–ù–ò–ô –ó–ê–ì–û–õ–û–í–û–ö ---
          final_title: >-
            {% if is_emergency %}
              üö® –ï–ö–°–¢–†–ï–ù–Ü –í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø!
            {% elif triggered_by_emergency and not is_emergency %}
              ‚úÖ –ï–∫—Å—Ç—Ä–µ–Ω—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ
            {% else %}
              {{ base_title }}
            {% endif %}

          # --- –¢–Ü–õ–û –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø (–ú–æ–±—ñ–ª—å–Ω–∏–π) ---
          body: >-
            üìç {{ location_name }}

            {% if is_emergency -%}
            ‚õîÔ∏è –£–í–ê–ì–ê! –í–≤–µ–¥–µ–Ω—ñ –µ–∫—Å—Ç—Ä–µ–Ω—ñ/–∞–≤–∞—Ä—ñ–π–Ω—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.
            –ì—Ä–∞—Ñ—ñ–∫–∏ –Ω–∞—Ä–∞–∑—ñ –ù–ï –î–Ü–Æ–¢–¨. –°–≤—ñ—Ç–ª–æ –º–æ–∂–µ –∑–Ω–∏–∫–∞—Ç–∏ –±–µ–∑ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è.
            {%- else -%}
            
            {% if events_today | length > 0 -%}
            üìÖ –°–¨–û–ì–û–î–ù–Ü ({{ now().strftime('%d.%m') }})
            {% for e in events_today -%}
            {%- set s = as_datetime(e.start).astimezone(now().tzinfo) -%}
            {%- set end = as_datetime(e.end).astimezone(now().tzinfo) -%}
            ‚ùå {{ s.strftime('%H:%M') }} ‚îÅ {{ end.strftime('%H:%M') }}
            {% endfor -%}
            {%- else -%}
            üìÖ –°–¨–û–ì–û–î–ù–Ü: ‚ö° –¥–∞–ª—ñ –±–µ–∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å
            {%- endif %}

            {% if events_tomorrow | length > 0 -%}
            üìÖ –ó–ê–í–¢–†–ê ({{ (now() + timedelta(days=1)).strftime('%d.%m') }})
            {% for e in events_tomorrow -%}
            {%- set s2 = as_datetime(e.start).astimezone(now().tzinfo) -%}
            {%- set e2 = as_datetime(e.end).astimezone(now().tzinfo) -%}
            ‚ùå {{ s2.strftime('%H:%M') }} ‚îÅ {{ e2.strftime('%H:%M') }}
            {% endfor -%}
            {%- endif %}
            {%- endif %}

          # --- –¢–Ü–õ–û –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø (Telegram) ---
          body_text: |-
            üìç {{ location_name }}

            {% if is_emergency -%}
            üö® <b>–£–í–ê–ì–ê! –í–≤–µ–¥–µ–Ω–æ –µ–∫—Å—Ç—Ä–µ–Ω—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è!</b>
            
            –ó–∞ —Ä–æ–∑–ø–æ—Ä—è–¥–∂–µ–Ω–Ω—è–º –£–∫—Ä–µ–Ω–µ—Ä–≥–æ –≤–≤–µ–¥–µ–Ω—ñ –∞–≤–∞—Ä—ñ–π–Ω—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.
            ‚ö†Ô∏è <b>–ì—Ä–∞—Ñ—ñ–∫–∏ –ø–ª–∞–Ω–æ–≤–∏—Ö –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –Ω–∞—Ä–∞–∑—ñ –ù–ï –î–Ü–Æ–¢–¨.</b>
            –°–≤—ñ—Ç–ª–æ –º–æ–∂–µ –≤–∏–º–∏–∫–∞—Ç–∏—Å—è —Ç–∞ –≤–º–∏–∫–∞—Ç–∏—Å—è –±–µ–∑ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –¥–ª—è —Å—Ç–∞–±—ñ–ª—ñ–∑–∞—Ü—ñ—ó –µ–Ω–µ—Ä–≥–æ—Å–∏—Å—Ç–µ–º–∏.
            {%- else -%}
            
            {% if events_today | length > 0 -%}
            üìÖ –°–¨–û–ì–û–î–ù–Ü ({{ now().strftime('%d.%m.%Y') }})
            {% for e in events_today -%}
            {%- set s = as_datetime(e.start).astimezone(now().tzinfo) -%}
            {%- set end = as_datetime(e.end).astimezone(now().tzinfo) -%}
            ‚ùå {{ s.strftime('%H:%M') }} ‚îÅ {{ end.strftime('%H:%M') }}
            {% endfor -%}
            {%- else -%}
            üìÖ –°–¨–û–ì–û–î–ù–Ü ({{ now().strftime('%d.%m.%Y') }}): ‚ö° –¥–∞–ª—ñ –±–µ–∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å
            {%- endif %}

            {% if events_tomorrow | length > 0 -%}
            üìÖ –ó–ê–í–¢–†–ê ({{ (now() + timedelta(days=1)).strftime('%d.%m.%Y') }})
            {% for e in events_tomorrow -%}
            {%- set s2 = as_datetime(e.start).astimezone(now().tzinfo) -%}
            {%- set e2 = as_datetime(e.end).astimezone(now().tzinfo) -%}
            ‚ùå {{ s2.strftime('%H:%M') }} ‚îÅ {{ e2.strftime('%H:%M') }}
            {% endfor -%}
            {%- endif %}
            {%- endif %}

      # 2.1) –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∏
      - repeat:
          for_each: !input mobile_targets
          sequence:
            - variables:
                svc: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
            - service: "{{ svc }}"
              data:
                title: "{{ final_title }}"
                message: "{{ body }}"
                data:
                  priority: "{{ 'high' if is_emergency else 'high' }}"
                  tag: svitlo_changed
                  channel: "{{ 'Emergency' if is_emergency else 'General' }}"
                  notification_icon: "{{ 'mdi:alert-octagon' if is_emergency else 'mdi:calendar-check' }}"
                  color: "{{ '#FF0000' if is_emergency else '' }}"

      # 2.2) Telegram
      - if:
          - condition: template
            value_template: "{{ telegram_chat_id != '' }}"
        then:
          - service: telegram_bot.send_message
            data:
              target: >-
                {% if telegram_chat_id is string %}
                  {{ telegram_chat_id.split(',') | map('trim') | list }}
                {% else %}
                  {{ telegram_chat_id }}
                {% endif %}
              title: "{{ final_title }}"
              message: "{{ body_text }}"
              parse_mode: HTML

      # 2.3) Persistent notification
      - if:
          - condition: template
            value_template: "{{ send_persistent_notification }}"
        then:
          - service: persistent_notification.create
            data:
              title: "{{ final_title }}"
              message: "{{ body }}"
              notification_id: svitlo_changed

      # 2.4) Helper write
      - if:
          - condition: template
            value_template: "{{ text_output != {} }}"
        then:
          - service: input_text.set_value
            target:
              entity_id: !input text_output
            data:
              value: "{{ body_text[:255] }}"

  # 4) –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø—ñ–¥–ø–∏—Å (–¢–Ü–õ–¨–ö–ò —è–∫—â–æ —Ü–µ –ù–ï –∞–≤–∞—Ä—ñ—è)
  - if:
      - condition: template
        value_template: "{{ not is_emergency }}"
    then:
      - service: input_text.set_value
        target:
          entity_id: !input storage_helper
        data:
          value: "{{ schedule_signature[-255:] }}"
