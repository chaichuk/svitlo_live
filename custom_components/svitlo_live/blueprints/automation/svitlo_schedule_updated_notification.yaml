blueprint:
  name: "Svitlo Live: –†–æ–∑—É–º–Ω—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è"
  description: "–ù–∞–¥—Å–∏–ª–∞—î push —Ç–∞ Telegram –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—ñ–≤ –ê–ë–û –≤–≤–µ–¥–µ–Ω–Ω—è –µ–∫—Å—Ç—Ä–µ–Ω–∏—Ö –≤—ñ–¥–∫–ª—é—á–µ–Ω—å."
  domain: automation
  source_url: https://github.com/chaichuk/svitlo_live

  input:
    schedule_calendar:
      name: –ö–∞–ª–µ–Ω–¥–∞—Ä Svitlo Live
      selector:
        entity:
          domain: calendar
          integration: svitlo_live

    schedule_updated_sensor:
      name: –°–µ–Ω—Å–æ—Ä –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—É
      selector:
        entity:
          domain: sensor
          integration: svitlo_live

    emergency_sensor:
      name: –°–µ–Ω—Å–æ—Ä –∞–≤–∞—Ä—ñ–π–Ω–∏—Ö –≤—ñ–¥–∫–ª—é—á–µ–Ω—å
      default: {}
      selector:
        entity:
          domain: binary_sensor
          integration: svitlo_live

    mobile_targets:
      name: –ú–æ–±—ñ–ª—å–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó (HA App)
      default: []
      selector:
        device:
          integration: mobile_app
          multiple: true

    telegram_chat_id:
      name: Telegram Chat ID
      default: ""
      selector:
        text:

    telegram_config_entry_id:
      name: Telegram Bot Config Entry ID
      description: "–î–ª—è –Ω–æ–≤–∏—Ö unified –±–æ—Ç—ñ–≤ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)"
      default: ""
      selector:
        text:

    title_text:
      name: –ó–∞–≥–æ–ª–æ–≤–æ–∫ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π)
      default: "‚ö†Ô∏è –û–Ω–æ–≤–ª–µ–Ω–æ –≥—Ä–∞—Ñ—ñ–∫–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å!"
      selector:
        text:

    location_name:
      name: –õ–æ–∫–∞—Ü—ñ—è
      default: "–î—ñ–º"
      selector:
        text:

    show_location:
      name: –ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –ª–æ–∫–∞—Ü—ñ—é –≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è—Ö
      default: true
      selector:
        boolean:

    storage_helper:
      name: Helper –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
      description: "Text helper –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ!)"
      selector:
        entity:
          domain: input_text

    text_output:
      name: Helper –¥–ª—è —Ç–µ–∫—Å—Ç—É —Ä–æ–∑–∫–ª–∞–¥—É (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)
      default: {}
      selector:
        entity:
          domain: input_text

    send_persistent_notification:
      name: –°—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ persistent_notification –≤ HA
      default: true
      selector:
        boolean:

    send_on_first_run:
      name: –ù–∞–¥—Å–∏–ª–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É
      default: true
      selector:
        boolean:

    notify_emergency_changes:
      name: –°–ø–æ–≤—ñ—â–∞—Ç–∏ –ø—Ä–æ –ï–∫—Å—Ç—Ä–µ–Ω—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
      default: true
      selector:
        boolean:

    quiet_mode:
      name: –¢–∏—Ö–∏–π —Ä–µ–∂–∏–º –≤–Ω–æ—á—ñ (23:00 - 05:00)
      default: false
      selector:
        boolean:

mode: restart

variables:
  cal_entity: !input schedule_calendar
  emergency_entity: !input emergency_sensor
  mobile_targets: !input mobile_targets
  telegram_chat_id: !input telegram_chat_id
  telegram_config_entry_id: !input telegram_config_entry_id
  base_title: !input title_text
  location_name: !input location_name
  storage_helper: !input storage_helper
  text_output: !input text_output
  send_persistent_notification: !input send_persistent_notification
  send_on_first_run: !input send_on_first_run
  notify_emergency_changes: !input notify_emergency_changes
  quiet_mode: !input quiet_mode
  show_location: !input show_location

  # –ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å –∞–≤–∞—Ä—ñ—ó
  is_emergency: >-
    {% if emergency_entity %}
      {{ is_state(emergency_entity, 'on') }}
    {% else %}
      false
    {% endif %}

  triggered_by_emergency: >-
    {{ trigger.entity_id is defined and trigger.entity_id == emergency_entity }}

trigger:
  - platform: state
    entity_id: !input schedule_updated_sensor
  - platform: state
    entity_id: !input emergency_sensor

condition:
  - condition: template
    value_template: "{{ trigger.from_state.state not in ['unknown', 'unavailable'] }}"

  # –¢–∏—Ö–∏–π —Ä–µ–∂–∏–º
  - condition: template
    value_template: >-
      {% if quiet_mode %}
        {% set current_hour = now().hour %}
        {{ not (current_hour >= 23 or current_hour < 5) }}
      {% else %}
        true
      {% endif %}

action:
  # –ó–∞—Ç—Ä–∏–º–∫–∞ –Ω–∞ –≤–∏–º–∫–Ω–µ–Ω–Ω—è –∞–≤–∞—Ä—ñ—ó (4 –≥–æ–¥–∏–Ω–∏)
  - if:
      - condition: template
        value_template: "{{ triggered_by_emergency and not is_emergency }}"
    then:
      - delay: "04:00:00"

  # –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
  - service: calendar.get_events
    target:
      entity_id: !input schedule_calendar
    data:
      start_date_time: "{{ today_at('00:00').isoformat() }}"
      end_date_time: "{{ (today_at('00:00') + timedelta(days=2) - timedelta(seconds=1)).isoformat() }}"
    response_variable: cal_resp

  - variables:
      raw_events: >-
        {% set r = cal_resp %}{% set k = cal_entity %}
        {% if r is mapping and (k in r) and (r[k] is mapping) and ('events' in r[k]) %}
          {{ r[k]['events'] | sort(attribute='start') }}
        {% else %}[]{% endif %}

      # –ü—ñ–¥–ø–∏—Å –ø–æ—Ç–æ—á–Ω–æ–≥–æ –≥—Ä–∞—Ñ—ñ–∫–∞
      schedule_signature: >-
        {%- set ns = namespace(sig='') -%}
        {%- for e in raw_events -%}
          {%- set s = as_datetime(e.start).strftime('%y%m%d%H%M') -%}
          {%- set t = as_datetime(e.end).strftime('%y%m%d%H%M') -%}
          {%- set ns.sig = ns.sig ~ s ~ t -%}
        {%- endfor -%}
        {{ ("c=" ~ (raw_events|count|string) ~ ";" ~ ns.sig) | trim }}

      # –û—Ç—Ä–∏–º—É—î–º–æ —Å—Ç–∞—Ä–∏–π –∑–∞–ø–∏—Å –∑ helper'–∞
      stored_data: "{{ states(storage_helper) | default('') }}"

      # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –±—É–ª–∞ –∞–∫—Ç–∏–≤–Ω–∞ –∞–≤–∞—Ä—ñ—è –º–∏–Ω—É–ª–æ–≥–æ —Ä–∞–∑—É (—à—É–∫–∞—î–º–æ –ø—Ä–µ—Ñ—ñ–∫—Å !E!)
      last_was_emergency: "{{ '!E!' in stored_data[:3] }}"

      # –û—Ç—Ä–∏–º—É—î–º–æ —á–∏—Å—Ç–∏–π –ø—ñ–¥–ø–∏—Å –≥—Ä–∞—Ñ—ñ–∫–∞ (–≤–∏–¥–∞–ª—è—î–º–æ –ø—Ä–µ—Ñ—ñ–∫—Å –∞–≤–∞—Ä—ñ—ó, —è–∫—â–æ –≤—ñ–Ω —î)
      old_signature: "{{ stored_data | replace('!E!', '') }}"

      # –õ–û–ì–Ü–ö–ê –ó–ú–Ü–ù (Anti-Spam)
      # 1. –ê–≤–∞—Ä—ñ—è –∑–º—ñ–Ω–∏–ª–∞—Å—å –¢–Ü–õ–¨–ö–ò —è–∫—â–æ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞—Ç—É—Å –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—î –∑ –∑–∞–ø–∏—Å–∞–Ω–∏–º —É —Ö–µ–ª–ø–µ—Ä—ñ.
      emergency_status_changed: "{{ is_emergency != last_was_emergency }}"

      # 2. –ì—Ä–∞—Ñ—ñ–∫ –∑–º—ñ–Ω–∏–≤—Å—è, —è–∫—â–æ –Ω–æ–≤–∏–π –ø—ñ–¥–ø–∏—Å –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—î –∑—ñ —Å—Ç–∞—Ä–∏–º
      schedule_has_changed: >-
        {% if send_on_first_run and stored_data == '' %}
          true
        {% else %}
          {{ schedule_signature[-250:] != old_signature[-250:] }}
        {% endif %}

      # –ó–∞–≥–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∏ —Ç—Ä–µ–±–∞ —â–æ—Å—å —Å–ª–∞—Ç–∏?
      should_notify: >-
        {% if emergency_status_changed and notify_emergency_changes %}
           true
        {% elif schedule_has_changed %}
           true
        {% else %}
           false
        {% endif %}

  - if:
      - condition: template
        value_template: "{{ should_notify }}"
    then:
      - variables:
          events_today: >-
            {% set today = now().astimezone(now().tzinfo).date() %}
            {% set current_time = now().astimezone(now().tzinfo) %}
            {% set ns = namespace(events=[]) %}
            {% for e in raw_events %}
              {% set e_start = as_datetime(e.start).astimezone(now().tzinfo) %}
              {% set e_end = as_datetime(e.end).astimezone(now().tzinfo) %}
              {% if e_start.date() == today and e_end > current_time %}
                {% set ns.events = ns.events + [e] %}
              {% endif %}
            {% endfor %}
            {{ ns.events }}

          events_tomorrow: >-
            {% set tomorrow = (now().astimezone(now().tzinfo) + timedelta(days=1)).date() %}
            {% set ns = namespace(events=[]) %}
            {% for e in raw_events %}
              {% if as_datetime(e.start).astimezone(now().tzinfo).date() == tomorrow %}
                {% set ns.events = ns.events + [e] %}
              {% endif %}
            {% endfor %}
            {{ ns.events }}

          # –ó–∞–≥–æ–ª–æ–≤–æ–∫
          final_title: >-
            {# –Ø–∫—â–æ —Å—Ç–∞—Ç—É—Å –∞–≤–∞—Ä—ñ—ó —Ä–µ–∞–ª—å–Ω–æ –∑–º—ñ–Ω–∏–≤—Å—è #}
            {% if emergency_status_changed and notify_emergency_changes %}
              {% if is_emergency %}
                üö® –ï–ö–°–¢–†–ï–ù–Ü –í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø!
              {% else %}
                ‚úÖ –ï–∫—Å—Ç—Ä–µ–Ω—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ
              {% endif %}
            {# –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –≤–∏–ø–∞–¥–æ–∫ #}
            {% else %}
              {{ base_title }}
            {% endif %}

          body: >-
            {%- if show_location and location_name %}
            üìç {{ location_name }}
            {%- endif %}
            {%- if is_emergency and notify_emergency_changes %}
            ‚õîÔ∏è –£–í–ê–ì–ê! –î—ñ—é—Ç—å –µ–∫—Å—Ç—Ä–µ–Ω—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.
            {%- endif %}
            {%- if events_today | length > 0 %}
            üìÖ –°–¨–û–ì–û–î–ù–Ü ({{ now().strftime('%d.%m') }})
            {%- for e in events_today %}
            {%- set s = as_datetime(e.start).astimezone(now().tzinfo) %}
            {%- set end = as_datetime(e.end).astimezone(now().tzinfo) %}
            ‚ùå {{ s.strftime('%H:%M') }} ‚îÅ {{ end.strftime('%H:%M') }}
            {%- endfor %}
            {%- else %}
            üìÖ –°–¨–û–ì–û–î–ù–Ü: ‚ö° –¥–∞–ª—ñ –±–µ–∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å
            {%- endif %}

            {%- if events_tomorrow | length > 0 %}
            üìÖ –ó–ê–í–¢–†–ê ({{ (now() + timedelta(days=1)).strftime('%d.%m') }})
            {%- for e in events_tomorrow %}
            {%- set s2 = as_datetime(e.start).astimezone(now().tzinfo) %}
            {%- set e2 = as_datetime(e.end).astimezone(now().tzinfo) %}
            ‚ùå {{ s2.strftime('%H:%M') }} ‚îÅ {{ e2.strftime('%H:%M') }}
            {%- endfor %}
            {%- endif %}
          body_text: |-
            {%- if show_location and location_name %}
            üìç {{ location_name }}
            {%- endif %}
            {%- if is_emergency and notify_emergency_changes %}
            üö® <b>–£–í–ê–ì–ê! –í–≤–µ–¥–µ–Ω–æ –µ–∫—Å—Ç—Ä–µ–Ω—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è!</b>
            –ì—Ä–∞—Ñ—ñ–∫–∏ –º–æ–∂—É—Ç—å –Ω–µ –¥—ñ—è—Ç–∏.
            {%- endif %}
            {%- if events_today | length > 0 %}
            üìÖ –°–¨–û–ì–û–î–ù–Ü ({{ now().strftime('%d.%m.%Y') }})
            {%- for e in events_today %}
            {%- set s = as_datetime(e.start).astimezone(now().tzinfo) %}
            {%- set end = as_datetime(e.end).astimezone(now().tzinfo) %}
            ‚ùå {{ s.strftime('%H:%M') }} ‚îÅ {{ end.strftime('%H:%M') }}
            {%- endfor %}
            {%- else %}
            üìÖ –°–¨–û–ì–û–î–ù–Ü: ‚ö° –¥–∞–ª—ñ –±–µ–∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å
            {%- endif %}
            {%- if events_tomorrow | length > 0 %}
            üìÖ –ó–ê–í–¢–†–ê ({{ (now() + timedelta(days=1)).strftime('%d.%m.%Y') }})
            {%- for e in events_tomorrow %}
            {%- set s2 = as_datetime(e.start).astimezone(now().tzinfo) %}
            {%- set e2 = as_datetime(e.end).astimezone(now().tzinfo) %}
            ‚ùå {{ s2.strftime('%H:%M') }} ‚îÅ {{ e2.strftime('%H:%M') }}
            {%- endfor %}
            {%- endif %}

      # 2.1) Mobile App
      - repeat:
          for_each: !input mobile_targets
          sequence:
            - variables:
                svc: "notify.mobile_app_{{ device_attr(repeat.item, 'name') | slugify }}"
            - service: "{{ svc }}"
              data:
                title: "{{ final_title }}"
                message: "{{ body }}"
                data:
                  priority: "high"
                  tag: svitlo_changed
                  channel: "{{ 'Emergency' if is_emergency else 'General' }}"
                  notification_icon: "{{ 'mdi:alert-octagon' if is_emergency else 'mdi:calendar-check' }}"
                  color: "{{ '#FF0000' if is_emergency else '' }}"

      # 2.2) Telegram
      - if:
          - condition: template
            value_template: "{{ telegram_chat_id != '' }}"
        then:
          - choose:
              # –ù–æ–≤–∏–π unified bot
              - conditions:
                  - condition: template
                    value_template: "{{ telegram_config_entry_id != '' }}"
                sequence:
                  - service: telegram_bot.send_message
                    data:
                      config_entry_id: "{{ telegram_config_entry_id }}"
                      target: >-
                        {% if telegram_chat_id is string %}
                          {{ telegram_chat_id.split(',') | map('trim') | list }}
                        {% else %}
                          {{ telegram_chat_id }}
                        {% endif %}
                      title: "{{ final_title }}"
                      message: "{{ body_text }}"
                      parse_mode: HTML
            # –°—Ç–∞—Ä–∏–π bot (–±–µ–∑ config_entry_id)
            default:
              - service: telegram_bot.send_message
                data:
                  target: >-
                    {% if telegram_chat_id is string %}
                      {{ telegram_chat_id.split(',') | map('trim') | list }}
                    {% else %}
                      {{ telegram_chat_id }}
                    {% endif %}
                  title: "{{ final_title }}"
                  message: "{{ body_text }}"
                  parse_mode: HTML

      # 2.3) Persistent Notification
      - if:
          - condition: template
            value_template: "{{ send_persistent_notification }}"
        then:
          - service: persistent_notification.create
            data:
              title: "{{ final_title }}"
              message: "{{ body }}"
              notification_id: svitlo_changed

      # 2.4) Helper write (Text Output)
      - if:
          - condition: template
            value_template: "{{ text_output != {} }}"
        then:
          - service: input_text.set_value
            target:
              entity_id: !input text_output
            data:
              value: "{{ body_text[:255] }}"

  # 4) –ó–ë–ï–†–Ü–ì–ê–Ñ–ú–û –°–¢–ê–ù (–ê–≤–∞—Ä—ñ—è + –ì—Ä–∞—Ñ—ñ–∫)
  # –ú–∏ –ø–∏—à–µ–º–æ –≤ helper –ó–ê–í–ñ–î–ò, —â–æ–± –∑–Ω–∞—Ç–∏, —á–∏ –º–∏ –≤ –∞–≤–∞—Ä—ñ—ó.
  # –Ø–∫—â–æ –∞–≤–∞—Ä—ñ—è - –¥–æ–¥–∞—î–º–æ –ø—Ä–µ—Ñ—ñ–∫—Å !E!
  - service: input_text.set_value
    target:
      entity_id: !input storage_helper
    data:
      value: "{% set sig = schedule_signature[-250:] %}{% if is_emergency %}!E!{{ sig }}{% else %}{{ sig }}{% endif %}"
